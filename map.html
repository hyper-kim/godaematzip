<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>Map</title>
    <style>
        body, html, #map { margin: 0; padding: 0; width: 100%; height: 100%; }
        .iw_wrap { padding: 10px; background: #fff; border-radius: 8px; text-align: center; min-width: 100px; }
        .iw_title { font-weight: bold; font-size: 14px; color: #333; margin-bottom: 4px; }
        .iw_category { font-size: 11px; color: #fff; padding: 2px 8px; border-radius: 10px; display: inline-block; }
    </style>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=xbuguzitkj"></script>
</head>
<body>
<div id="map"></div>
<script>
    // URL에서 데이터 가져오기 (압축 해제)
    const urlParams = new URLSearchParams(window.location.search);
    const markersParam = urlParams.get('data'); // 'markers' -> 'data'로 변경
    
    var map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.5894, 127.0323),
        zoom: 16,
        scaleControl: false, logoControl: false, mapDataControl: false, zoomControl: false
    });

    var bounds = new naver.maps.LatLngBounds();
    var validMarkers = [];

    function getCategoryColor(c) {
        if (!c) return '#333';
        if (c.indexOf('한식')!==-1) return '#FF4B4B';
        if (c.indexOf('중식')!==-1) return '#FFC400';
        if (c.indexOf('일식')!==-1) return '#4A90E2';
        if (c.indexOf('양식')!==-1) return '#27AE60';
        if (c.indexOf('분식')!==-1) return '#FF8A00';
        if (c.indexOf('아시안')!==-1) return '#8E44AD';
        return '#333';
    }

    if (markersParam) {
        try {
            var decodedData = decodeURIComponent(markersParam);
            var markerList = JSON.parse(decodedData);

            if (Array.isArray(markerList) && markerList.length > 0) {
                markerList.forEach(function(s) {
                    // n:이름, c:카테고리, a:위도(lat), o:경도(lng) - 압축 변수명 사용
                    if (s.a && s.o && s.a !== 0 && s.o !== 0) {
                        var position = new naver.maps.LatLng(s.a, s.o);
                        bounds.extend(position);
                        validMarkers.push(position);

                        var color = getCategoryColor(s.c);
                        var markerHtml = '<div style="position:relative;width:30px;height:38px;">' +
                            '<div style="position:absolute;top:0;left:0;width:30px;height:30px;background:'+color+';border-radius:50%;border:3px solid white;box-shadow:0 3px 6px rgba(0,0,0,0.3);box-sizing:border-box;"></div>' +
                            '<div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:10px solid '+color+';"></div>' +
                            '</div>';

                        var marker = new naver.maps.Marker({
                            position: position, map: map,
                            icon: { content: markerHtml, size: new naver.maps.Size(30, 38), anchor: new naver.maps.Point(15, 38) }
                        });

                        var infoWindow = new naver.maps.InfoWindow({
                            content: '<div class="iw_wrap"><div class="iw_title">'+s.n+'</div><div class="iw_category" style="background:'+color+'">'+s.c+'</div></div>',
                            borderWidth: 0, backgroundColor: "transparent", disableAnchor: true, pixelOffset: new naver.maps.Point(0, -10)
                        });

                        naver.maps.Event.addListener(marker, "click", function() {
                            if (infoWindow.getMap()) infoWindow.close(); else infoWindow.open(map, marker);
                        });
                    }
                });

                // 자동 줌 이동
                if (validMarkers.length === 1) {
                    map.setCenter(validMarkers[0]); map.setZoom(17);
                } else if (validMarkers.length > 1) {
                    map.fitBounds(bounds, { top: 50, right: 30, bottom: 50, left: 30 });
                }
            }
        } catch (e) { console.error(e); }
    }
</script>
</body>
</html>
